#!/bin/sh

function connect {
	bluetoothctl power on
	bluetoothctl connect "$1" && notify-send "Bluetooth" "游닉 Connected to $2" || notify-send "Bluetooth" "游닉仇Failed to connect to $2"
}

cmds="" # List of commands to run (first line will be removed)

# Disconnect
connected=$(bluetoothctl info | grep Connected | cut -d ' ' -f 2)
[ "$connected" = "yes" ] &&
	cmds+="
游 Disconnect 	bluetoothctl disconnect 	游 Disconnected"

# State
state=$(bluetoothctl show | grep Powered | cut -d ' ' -f 2)
[ "$state" = "no" ] &&
	cmds+="
游릭 ON 	bluetoothctl power on	游릭 Powered ON" ||
	cmds+="
游댮 OFF 	bluetoothctl power off 	游댮 Powered OFF"

# Scan
cmds+="
游댍 Scan 	setsid -f bluetoothctl scan on 	游댍 Scanning"

# Devices
devices=$(bluetoothctl devices | cut -d ' ' -f 2-)
readarray -t devices <<< $(echo -e "$devices")
for device in "${devices[@]}"; do
	deviceName=$(echo "$device" | cut -d ' ' -f 2-)
	deviceUID=$(echo "$device" | cut -d ' ' -f 1)
	[ -z "$deviceName" ] && continue
	[ -z "$deviceName" ] && continue
	cmds="$cmds
游닉 $deviceName 	connect $deviceUID $deviceName"
done

# Omit first line (empty line)
cmds=$(echo "$cmds" | tail -n +2)
# Present choices
choice="$(echo "$cmds" | cut -d'	' -f 1 | dmenu -p "Bluetooth")" || exit 1
# Execute choice
`echo "$cmds" | grep "^$choice	" | cut -d '	' -f 2`
# Show notification
notification_text=$(echo "$cmds" | grep "^$choice	" | cut -d '	' -f 3)
[ -n "$notification_text" ] && notify-send "Bluetooth" "$notification_text"
